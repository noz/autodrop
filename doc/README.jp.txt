autodrop README

NOZAWA Hiromasa, Tokyo, Japan


= 概要

ホストへのしつこいアクセスを iptables で弾くデーモン。

syslog のログを監視して、パターンにマッチするログを一定期間内に繰り返し
生じさせるホストを iptables の DROP ルールでアクセス禁止にする。

監視するログのパターン、ログの発生回数、発生回数のカウントを続ける期間
を設定できる。パターンは複数設定できる。

複数のログファイルをポーリングしたり stat したりせずに、単一の名前つき
パイプを見るようになっている。このため syslogd が目的のログを名前つきパ
イプへ吐くように設定する必要がある (syslog.conf で '|' を使う)。

Ruby 製です。Ruby なので、というかスクリプト言語製なので本格的に高トラ
フィックな環境には向かないでしょう。でもウチでは毎日々々延々と 22 番を
叩きにくる人たちをしっかり弾いてくれるので重宝してます。なかなか重宝す
るので公開してみます。

この手のツールの常として自分を自分のホストから締め出すことも可能なので
注意してください。


= 必要なもの

* iptables なので linux
* syslogd
* ruby 1.8.6 あたり


= ライセンス

BSD


= インストール

gem install したあと設定ファイルを作る必要があります。
#! 行も必要なら書き換えてください。

*1. gem install autodrop

*2. cd <GEMDIR>/gems/autodrop-x.x.x/conf

*3. sudo cp autodrop.conf.default /etc

*6. /etc/autodrop.conf を編集


= 使い方

== 起動

root で実行するようになってます。

	------------------------------
	$ sudo ruby autodrop.rb
	------------------------------

設定ファイルのデフォルトは /etc/autodrop.conf です。
コマンドラインから指定すれば別の場所にある設定ファイルも使えます。

	------------------------------
	$ ruby autodrop.rb -c /foo/bar/autodrop.conf
	------------------------------

起動すると /var/run/autodrop.pid が作られます。

== 停止

	------------------------------
	$ sudo kill `cat /var/run/autodrop.pid`
	------------------------------

== 稼働中

autodrop 自身もプレフィクス `autodrop' で起動、終了、DROP の発生を
syslog に吐きます。

稼働中は iptables の INPUT テーブルに DROP ルールが溜まる一方になるので、
たまに手でクリアすることになるかと思います。定期的にクリアするような機
能はありません。


= autodrop.conf

どの設定も省略不可。どれも単なる ruby の定数です。

* MESSAGES_TO_WATCH

	監視するメッセージのパターンを正規表現で書いた配列。
	$1 がリモートホストの IP アドレスにマッチするようにする。

	------------------------------
	MESSAGES_TO_WATCH =
	  [
           # OpenSSH's
	   /Invalid user [^\s]+ from (.+)/,
	   /Address (.+) maps to.*POSSIBLE BREAK-IN ATTEMPT!/,
	  ]
	------------------------------

* COUNT_MAX

	DROP するまでのマッチ回数。

	------------------------------
	COUNT_MAX = 3
	------------------------------

* INTERVAL

	マッチしたパターン (パターンと IP アドレスの組) についてカウン
	トをとり続ける時間。秒で指定する。
	マッチするたびに 0 に戻る。

	------------------------------
	INTERVAL = 10
	------------------------------

* IPTABLES_PROGRAM

	用いる iptables を指定する。

	------------------------------
	IPTABLES_PROGRAM = '/bin/iptables'
	------------------------------

* PIDFILE

	pid ファイルのパス。

	------------------------------
	PIDFILE = '/var/run/autodrop.pid'
	------------------------------

* WATCH_FIFO

	監視する名前つきパイプのパス。

	------------------------------
	WATCH_FIFO = '/var/log/authfifo'
	------------------------------


= 参考: syslogd の設定例

パイプを作って、
	------------------------------
	sudo mkfifo /var/log/authfifo
	------------------------------
syslog.conf に登録する。
	------------------------------
	authpriv.*		|/var/log/authfifo
	------------------------------

「|」で名前つきパイプへの出力になる。詳しくは syslog.conf(5) で。

#eof
